<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>COGITATEUR DE RECRUTEMENT - W&G</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- CSS SP√âCIFIQUE AU BUILDER --- */
        
        .phase-container { display: none; animation: fadeIn 0.4s ease-in-out; }
        .phase-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* PHASE 2 : LISTE ARCHETYPES */
        .arch-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .arch-card {
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid #1a5c00;
            padding: 15px;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }
        .arch-card:hover {
            border-color: #33ff00;
            background: #001a00;
            box-shadow: 0 0 15px rgba(51, 255, 0, 0.2);
        }
        .arch-tier-badge {
            position: absolute; top: 0; right: 0;
            background: #33ff00; color: #000;
            font-weight: bold; padding: 2px 8px; font-size: 0.8em;
        }

        /* PHASE 3 : BUILDER LAYOUT */
        .builder-layout { display: flex; gap: 20px; height: 75vh; margin-top: 10px; }
        
        .sidebar { 
            width: 280px; 
            background: rgba(0, 15, 0, 0.9); 
            border: 2px solid #1a5c00; 
            padding: 15px; 
            overflow-y: auto; 
            font-size: 0.9em;
        }

        .main-view { 
            flex-grow: 1; 
            background: rgba(0, 5, 0, 0.6); 
            border: 1px solid #33ff00; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
        }

        .xp-header {
            background: black;
            border: 1px solid #33ff00;
            padding: 10px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Courier New', monospace;
        }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #1a5c00; }
        .tab-btn {
            background: #001000;
            color: #1a5c00;
            border: 1px solid #1a5c00;
            border-bottom: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .tab-btn.active {
            background: #1a5c00;
            color: #33ff00;
            border-color: #33ff00;
            padding-bottom: 12px;
            margin-bottom: -1px;
        }
        .tab-content { display: none; height: 100%; overflow-y: auto; }
        .tab-content.active { display: block; }

        .stat-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 0; border-bottom: 1px dotted #1a5c00; 
        }
        .ctrl-btn {
            background: black; color: #33ff00; border: 1px solid #33ff00;
            width: 25px; height: 25px; cursor: pointer;
        }
        .ctrl-btn:hover { background: #33ff00; color: black; }
        
        .inv-item { 
            border: 1px solid #1a5c00; padding: 5px; margin-bottom: 5px; 
            display: flex; justify-content: space-between; 
            background: rgba(0,0,0,0.5);
        }

        /* BOUTONS DE FILTRE ARMURERIE */
        .gear-filters { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .gear-cat-btn {
            background: black; border: 1px solid #1a5c00; color: #1a5c00;
            padding: 5px 10px; font-size: 0.8em; cursor: pointer; flex-grow: 1;
            font-family: 'Courier New', monospace; font-weight: bold;
        }
        .gear-cat-btn.active { background: #1a5c00; color: #33ff00; border-color: #33ff00; }
        .gear-cat-btn:hover { border-color: #33ff00; color: #33ff00; }

    </style>
</head>
<body class="hud-screen">
    
    <nav>
        <a href="index.html">Terminal</a>
        <a href="races.html" class="active">Cr√©ation</a>
        <a href="armurerie.html">Armurerie</a>
        <a href="codex.html">CODEX</a>
    </nav>

    <div class="screen-content">
        <div class="container">

            <div id="phase-1" class="phase-container active">
                <div class="top-hud-bar">
                    <div style="text-align:center; width:100%; border: 1px solid #33ff00; background: rgba(51, 255, 0, 0.1);">
                        <span style="font-size: 1.5em; font-weight:bold;">INITIALISATION DU PROTOCOLE G√âN√âTIQUE</span>
                    </div>
                </div>
                <p style="text-align:center; color:#888;">S√©lectionnez l'all√©geance principale de l'agent.</p>

                <div class="grid">
                    <div class="sub-faction-card" onclick="goToPhase2('imperium')"> <div class="sub-faction-icon">‚ú†</div> <h3>IMPERIUM</h3> </div>
                    <div class="sub-faction-card" onclick="goToPhase2('chaos')"> <div class="sub-faction-icon">‚ò†</div> <h3>CHAOS</h3> </div>
                    <div class="sub-faction-card" onclick="goToPhase2('aeldari')"> <div class="sub-faction-icon">üëÅ</div> <h3>AELDARI</h3> </div>
                    <div class="sub-faction-card" onclick="goToPhase2('orks')"> <div class="sub-faction-icon">V</div> <h3>ORKS</h3> </div>
                    <div class="sub-faction-card" onclick="goToPhase2('tau')"> <div class="sub-faction-icon">‚óé</div> <h3>EMPIRE T'AU</h3> </div>
                    <div class="sub-faction-card" onclick="goToPhase2('necrons')"> <div class="sub-faction-icon">üíÄ</div> <h3>NECRONS</h3> </div>
                    <div class="sub-faction-card" onclick="goToPhase2('scum')"> <div class="sub-faction-icon">‚õì</div> <h3>MARGINAUX</h3> </div>
                    <div class="sub-faction-card" onclick="goToPhase2('tyranids')"> <div class="sub-faction-icon">üêú</div> <h3>TYRANIDES</h3> </div>
                </div>
            </div>

            <div id="phase-2" class="phase-container">
                <button class="btn-tactical" onclick="goToPhase1()"> &lt; RETOUR FACTIONS</button>
                <h2 id="faction-title" style="color:#d4af37; border-bottom:2px solid #d4af37; margin-top:10px;">TITRE FACTION</h2>
                <div id="archetype-list" class="arch-list-container"></div>
            </div>

            <div id="phase-3" class="phase-container">
                <button class="btn-tactical" onclick="goToPhase2(currentFactionKey)"> &lt; CHANGER ARCH√âTYPE</button>
                
                <div class="builder-layout">
                    <div class="sidebar">
                        <h3 style="color:#33ff00; border-bottom:1px solid #33ff00;">IDENTIT√â</h3>
                        <div style="margin-bottom:15px;">
                            <label>Nom :</label>
                            <input type="text" id="char-name" value="Nouvel Agent" style="width:100%; background:black; color:#33ff00; border:1px solid #1a5c00;">
                        </div>
                        <div><strong>Arch√©type:</strong> <span id="summ-arch" style="color:#d4af37;">-</span></div>
                        <div><strong>Tier:</strong> <span id="summ-tier">-</span></div>
                        <div style="font-size:0.8em; color:#aaa; margin-top:5px;"><strong>Mots-Cl√©s:</strong><br><span id="summ-keywords">-</span></div>

                        <h3 style="color:#33ff00; border-bottom:1px solid #33ff00; margin-top:20px;">STATS D√âRIV√âES</h3>
                        <div class="stat-row"><span>PV (Wounds)</span> <span id="d-wounds" class="highlight">0</span></div>
                        <div class="stat-row"><span>Choc (Shock)</span> <span id="d-shock" class="highlight">0</span></div>
                        <div class="stat-row"><span>D√©fense</span> <span id="d-def" class="highlight">0</span></div>
                        <div class="stat-row"><span>R√©silience</span> <span id="d-res" class="highlight">0</span></div>
                        <div class="stat-row"><span>Influence</span> <span id="d-inf" class="highlight">0</span></div>
                        <div class="stat-row"><span>Richesse</span> <span id="d-wealth" class="highlight">0</span></div>
                    </div>

                    <div class="main-view">
                        <div class="xp-header">
                            <span>CAPACIT√â D'EXP√âRIENCE</span>
                            <span style="font-size:1.4em;">
                                <span id="xp-spent" style="color:#33ff00;">0</span> / <span id="xp-max" style="color:#d4af37;">0</span> XP
                            </span>
                        </div>

                        <div class="tabs">
                            <button class="tab-btn active" onclick="showTab('tab-attrs', this)">ATTRIBUTS</button>
                            <button class="tab-btn" onclick="showTab('tab-skills', this)">COMP√âTENCES</button>
                            <button class="tab-btn" onclick="showTab('tab-gear', this)">ARSENAL</button>
                            <button class="tab-btn" onclick="showTab('tab-export', this)">DONN√âES</button>
                        </div>

                        <div id="tab-attrs" class="tab-content active">
                            <h3>ATTRIBUTS PRIMAIRES</h3>
                            <div id="attrs-container"></div>
                        </div>

                        <div id="tab-skills" class="tab-content">
                            <h3>COMP√âTENCES</h3>
                            <div id="skills-container" style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;"></div>
                        </div>

                        <div id="tab-gear" class="tab-content">
                            <div style="display:flex; gap:20px; height:100%;">
                                <div style="flex:1; border-right:1px solid #1a5c00; padding-right:10px;">
                                    <h4 style="color:#d4af37;">LOGISTIQUE DISPONIBLE</h4>
                                    
                                    <div class="gear-filters">
                                        <button class="gear-cat-btn active" onclick="filterGear('ALL', this)">TOUT</button>
                                        <button class="gear-cat-btn" onclick="filterGear('MELEE', this)">M√äL√âE</button>
                                        <button class="gear-cat-btn" onclick="filterGear('RANGED', this)">DISTANCE</button>
                                        <button class="gear-cat-btn" onclick="filterGear('ARMOR', this)">ARMURES</button>
                                        <button class="gear-cat-btn" onclick="filterGear('GEAR', this)">MAT√âRIEL</button>
                                        <button class="gear-cat-btn" onclick="filterGear('CYBER', this)">CYBER</button>
                                    </div>

                                    <input type="text" id="gear-search" placeholder="Rechercher..." onkeyup="renderGearList()" style="width:100%; background:black; color:#33ff00; border:1px solid #1a5c00; margin-bottom:10px;">
                                    <div id="gear-list" style="height:300px; overflow-y:auto;"></div>
                                </div>
                                <div style="flex:1; padding-left:10px;">
                                    <h4 style="color:#33ff00;">INVENTAIRE</h4>
                                    <div id="inventory-list"></div>
                                </div>
                            </div>
                        </div>

<div id="tab-export" class="tab-content">
    <h3>CODE NOOSPH√âRIQUE</h3>
    <p style="color:#888; font-size:0.9em;">Sauvegardez ce fichier pour recharger votre agent plus tard.</p>
    
    <textarea id="json-export" style="width:100%; height:200px; background:black; color:#33ff00; border:1px solid #1a5c00; margin-bottom:10px; font-family:monospace;"></textarea>
    
    <div style="display:flex; gap:10px;">
        <button class="btn-tactical" onclick="exportData()" style="flex:1;">ACTUALISER LE CODE</button>
        <button class="btn-tactical" onclick="downloadFile()" style="flex:1; border-color:#d4af37; color:#d4af37;">T√âL√âCHARGER FICHIER .JSON</button>
    </div>
</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="races-script.js"></script>
    <script src="armory-script.js"></script>

    <script>
    const attributesList = ["Force", "Endurance", "Agilit√©", "Initiative", "Volont√©", "Intellect", "Sociabilit√©"];
    const skillsList = ["Athl√©tisme", "Vigilance", "Tir", "Corps √† corps", "Furtivit√©", "Pilotage", "Tech", "Medicae", "Commandement", "Investigation", "Persuasion", "Survie"];
    const xpAttrCosts = [0, 0, 4, 10, 20, 35, 55, 80, 110, 145, 185, 230, 280];
    const xpSkillCosts = [0, 0, 2, 6, 12, 20, 30, 42, 56];

    let currentFactionKey = "";
    let currentGearCat = "ALL"; 
    let charSheet = {
        archetypeId: null, tier: 1, xpSpent: 0,
        attributes: {}, skills: {}, inventory: [], keywords: []
    };

    attributesList.forEach(a => charSheet.attributes[a] = 1);
    skillsList.forEach(s => charSheet.skills[s] = 0);

    function showPhase(id) {
        document.querySelectorAll('.phase-container').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goToPhase2(fKey) {
        currentFactionKey = fKey;
        let data = typeof factionData !== 'undefined' ? factionData : (typeof archetypeData !== 'undefined' ? archetypeData : null);
        
        if (!data) { alert("Erreur : Aucun script de donn√©es (races-script.js) n'est charg√©."); return; }
        
        const faction = data[fKey];
        if(!faction) return;

        document.getElementById('faction-title').innerText = faction.title;
        const list = document.getElementById('archetype-list');
        list.innerHTML = "";
        const sorted = [...faction.units].sort((a,b) => a.tier - b.tier);

        sorted.forEach(u => {
            let color = u.tier >= 3 ? "#d4af37" : "#33ff00"; 
            if (u.tier >= 5) color = "#ff3333";
            list.innerHTML += `
            <div class="arch-card" onclick="initBuilder('${u.id}')">
                <span class="arch-tier-badge" style="background:${color}; color:black;">T${u.tier}</span>
                <h3 style="color:#d4af37; margin-top:10px;">${u.name}</h3>
                <p style="color:#aaa; font-size:0.9em;">${u.desc}</p>
                <div style="margin-top:10px; color:#33ff00; font-size:0.8em; text-align:right;">[ S√âLECTIONNER ]</div>
            </div>`;
        });
        showPhase('phase-2');
    }

    function goToPhase1() { showPhase('phase-1'); }

    // --- FONCTION DE CORRECTION DES MOTS-CL√âS ---
    function getCorrectKeyword(factionKey) {
        const mapping = {
            "ORKS": "ORK",          // "ORKS" devient "ORK" pour l'armurerie
            "TAU": "T'AU",          // "TAU" devient "T'AU"
            "AELDARI": "AELDARI",
            "NECRONS": "NECRONS",
            "IMPERIUM": "IMPERIUM",
            "CHAOS": "CHAOS",
            "SCUM": "SCUM",
            "TYRANIDS": "TYRANIDS"
        };
        return mapping[factionKey] || factionKey;
    }

    function initBuilder(archId) {
        let unitData = null;
        let fKeyFound = "";
        
        let data = typeof factionData !== 'undefined' ? factionData : (typeof archetypeData !== 'undefined' ? archetypeData : null);
        if (!data) return;

        for(const [k, f] of Object.entries(data)) {
            const u = f.units.find(x => x.id === archId);
            if(u) { unitData = u; fKeyFound = k.toUpperCase(); break; }
        }
        if(!unitData) return;

        // Reset Fiche
        charSheet.archetypeId = archId;
        charSheet.tier = unitData.tier;
        charSheet.xpSpent = 0;
        charSheet.inventory = [];
        
        // --- APPLICATION DES MOTS-CL√âS (CORRIG√âE) ---
        // On ajoute la version corrig√©e pour l'armurerie (ex: ORK)
        charSheet.keywords = [getCorrectKeyword(fKeyFound)];
        
        // On ajoute aussi la version brute pour √™tre s√ªr (ex: ORKS)
        if(fKeyFound !== getCorrectKeyword(fKeyFound)) {
            charSheet.keywords.push(fKeyFound);
        }

        const sId = archId.toLowerCase();
        if(sId.includes('marine') || sId.includes('tactical')) charSheet.keywords.push('ASTARTES', 'IMPERIUM');
        if(sId.includes('sister')) charSheet.keywords.push('ADEPTA SORORITAS', 'IMPERIUM');
        if(sId.includes('ork') || sId.includes('boy')) charSheet.keywords.push('ORK');
        if(sId.includes('scum') || sId.includes('guard')) charSheet.keywords.push('IMPERIUM', 'SCUM');

        attributesList.forEach(a => charSheet.attributes[a] = 1);
        skillsList.forEach(s => charSheet.skills[s] = 0);

        document.getElementById('summ-arch').innerText = unitData.name;
        document.getElementById('summ-tier').innerText = unitData.tier;
        document.getElementById('xp-max').innerText = unitData.tier * 100;
        document.getElementById('summ-keywords').innerText = charSheet.keywords.join(", ");

        renderAttributes();
        renderSkills();
        
        // REFRESH TOTAL ARMURERIE
        currentGearCat = 'ALL';
        document.querySelectorAll('.gear-cat-btn').forEach(b => b.classList.remove('active'));
        if(document.querySelector('.gear-cat-btn')) document.querySelector('.gear-cat-btn').classList.add('active');
        renderGearList(); 
        
        calculateStats();
        showPhase('phase-3');
    }

    function renderAttributes() {
        const c = document.getElementById('attrs-container');
        c.innerHTML = "";
        attributesList.forEach(attr => {
            c.innerHTML += `
            <div class="stat-row">
                <span style="width:100px;">${attr}</span>
                <div>
                    <button class="ctrl-btn" onclick="modAttr('${attr}', -1)">-</button>
                    <span class="stat-val" style="display:inline-block; width:30px; text-align:center;">${charSheet.attributes[attr]}</span>
                    <button class="ctrl-btn" onclick="modAttr('${attr}', 1)">+</button>
                </div>
            </div>`;
        });
    }

    function modAttr(attr, delta) {
        const oldVal = charSheet.attributes[attr];
        const newVal = oldVal + delta;
        if(newVal < 1 || newVal > 12) return;
        const cost = xpAttrCosts[newVal] - xpAttrCosts[oldVal];
        if(charSheet.xpSpent + cost > charSheet.tier * 100) { alert("XP Insuffisant !"); return; }
        charSheet.attributes[attr] = newVal;
        charSheet.xpSpent += cost;
        renderAttributes();
        calculateStats();
    }

    function renderSkills() {
        const c = document.getElementById('skills-container');
        c.innerHTML = "";
        skillsList.forEach(s => {
            c.innerHTML += `
            <div class="stat-row">
                <span>${s}</span>
                <div>
                    <button class="ctrl-btn" onclick="modSkill('${s}', -1)">-</button>
                    <span class="stat-val" style="display:inline-block; width:30px; text-align:center;">${charSheet.skills[s]}</span>
                    <button class="ctrl-btn" onclick="modSkill('${s}', 1)">+</button>
                </div>
            </div>`;
        });
    }

    function modSkill(s, delta) {
        const oldVal = charSheet.skills[s];
        const newVal = oldVal + delta;
        if(newVal < 0 || newVal > 8) return;
        const cost = xpSkillCosts[newVal] - xpSkillCosts[oldVal];
        if(charSheet.xpSpent + cost > charSheet.tier * 100) { alert("XP Insuffisant !"); return; }
        charSheet.skills[s] = newVal;
        charSheet.xpSpent += cost;
        renderSkills();
        calculateStats();
    }

    // --- FONCTION DE FILTRE PAR CAT√âGORIE ---
    function filterGear(cat, btn) {
        currentGearCat = cat;
        document.querySelectorAll('.gear-cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderGearList();
    }

    function renderGearList() {
        if (typeof armoryData === 'undefined') { document.getElementById('gear-list').innerHTML = "Erreur: armory-script.js manquant."; return; }
        
        const search = document.getElementById('gear-search').value.toLowerCase();
        const c = document.getElementById('gear-list');
        c.innerHTML = "";

        armoryData.forEach(item => {
            const matchesSearch = item.name.toLowerCase().includes(search);
            
            // FILTRE CAT√âGORIE
            let matchesCat = false;
            if (currentGearCat === 'ALL') matchesCat = true;
            else if (item.type === currentGearCat) matchesCat = true;

            // COMPATIBILIT√â (Mots-cl√©s)
            let compatible = false;
            if(item.rarity === 'Commun') compatible = true;
            if(item.keywords && item.keywords.some(k => charSheet.keywords.includes(k))) compatible = true;
            if(charSheet.keywords.includes('IMPERIUM') && item.keywords.includes('ORK') && !charSheet.keywords.includes('SCUM')) compatible = false;

            if(matchesSearch && matchesCat && compatible) {
                c.innerHTML += `
                <div class="inv-item" style="cursor:pointer;" onclick="addItem('${item.id}')">
                    <div>
                        <strong style="color:#d4af37;">${item.name}</strong>
                        <div style="font-size:0.7em; color:#aaa;">${item.type} | ${item.rarity}</div>
                    </div>
                    <div style="color:#33ff00;">+</div>
                </div>`;
            }
        });
    }

    function addItem(id) {
        const item = armoryData.find(i => i.id === id);
        charSheet.inventory.push(item);
        renderInventory();
    }

    function renderInventory() {
        const c = document.getElementById('inventory-list');
        c.innerHTML = charSheet.inventory.map((item, idx) => `
            <div class="inv-item">
                <span>${item.name}</span>
                <span style="color:red; cursor:pointer;" onclick="remItem(${idx})">[X]</span>
            </div>
        `).join('');
    }

    function remItem(idx) {
        charSheet.inventory.splice(idx, 1);
        renderInventory();
    }

    function calculateStats() {
        document.getElementById('xp-spent').innerText = charSheet.xpSpent;
        const T = charSheet.attributes["Endurance"];
        const Tr = charSheet.tier;
        document.getElementById('d-wounds').innerText = T + (Tr * 2);
        document.getElementById('d-shock').innerText = charSheet.attributes["Volont√©"] + Tr;
        document.getElementById('d-def').innerText = Math.max(1, charSheet.attributes["Initiative"] - 1);
        document.getElementById('d-res').innerText = T + 1; 
        document.getElementById('d-inf').innerText = Math.max(1, charSheet.attributes["Sociabilit√©"] - 1);
        document.getElementById('d-wealth').innerText = Tr;
    }

    function showTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    function exportData() {
        document.getElementById('json-export').value = JSON.stringify(charSheet, null, 4);
    }
    function exportData() {
        // Met √† jour le nom dans l'objet charSheet avant l'export
        charSheet.name = document.getElementById('char-name').value || "Nouvel Agent";
        
        const json = JSON.stringify(charSheet, null, 4);
        document.getElementById('json-export').value = json;
    }

    function downloadFile() {
        // 1. S'assurer que les donn√©es sont √† jour
        exportData();
        
        // 2. Cr√©er le contenu du fichier
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(charSheet, null, 4));
        const fileName = (charSheet.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()) + "_fiche.json";
        
        // 3. Cr√©er un lien de t√©l√©chargement invisible et cliquer dessus
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", fileName);
        document.body.appendChild(downloadAnchorNode); // Requis pour Firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }
    </script>
</body>
</html>